import { ObjectId } from 'mongodb';

export async function getProjectDependencyCounts(db, projectId) {
  const projectObjectId = projectId instanceof ObjectId ? projectId : new ObjectId(projectId);

  const [
    materials,
    expenses,
    initialExpenses,
    floors,
    phases,
    workItems,
    labourEntries,
    labourBatches,
    labourCostSummaries,
    materialRequests,
    materialRequestBatches,
    purchaseOrders,
    equipment,
    subcontractors,
    professionalServices,
    professionalFees,
    professionalActivities,
    siteReports,
    supervisorSubmissions,
    budgetReallocations,
    budgetAdjustments,
    budgetTransfers,
    contingencyDraws,
    approvals,
    projectMemberships,
    projectTeams,
    notifications,
    auditLogs,
    scheduledReports, // CRITICAL: Added missing scheduled_reports dependency
  ] = await Promise.all([
    db.collection('materials').countDocuments({ projectId: projectObjectId, deletedAt: null }),
    db.collection('expenses').countDocuments({ projectId: projectObjectId, deletedAt: null }),
    db.collection('initial_expenses').countDocuments({ projectId: projectObjectId, status: { $ne: 'deleted' } }),
    db.collection('floors').countDocuments({ projectId: projectObjectId }),
    db.collection('phases').countDocuments({ projectId: projectObjectId, deletedAt: null }),
    db.collection('work_items').countDocuments({ projectId: projectObjectId, deletedAt: null }),
    db.collection('labour_entries').countDocuments({ projectId: projectObjectId, deletedAt: null }),
    db.collection('labour_batches').countDocuments({ projectId: projectObjectId, deletedAt: null }),
    db.collection('labour_cost_summaries').countDocuments({ projectId: projectObjectId, deletedAt: null }),
    db.collection('material_requests').countDocuments({ projectId: projectObjectId, deletedAt: null }),
    db.collection('material_request_batches').countDocuments({ projectId: projectObjectId, deletedAt: null }),
    db.collection('purchase_orders').countDocuments({ projectId: projectObjectId, deletedAt: null }),
    db.collection('equipment').countDocuments({ projectId: projectObjectId, deletedAt: null }),
    db.collection('subcontractors').countDocuments({ projectId: projectObjectId, deletedAt: null }),
    db.collection('professional_services').countDocuments({ projectId: projectObjectId, deletedAt: null }),
    db.collection('professional_fees').countDocuments({ projectId: projectObjectId, deletedAt: null }),
    db.collection('professional_activities').countDocuments({ projectId: projectObjectId, deletedAt: null }),
    db.collection('site_reports').countDocuments({ projectId: projectObjectId, deletedAt: null }),
    db.collection('supervisor_submissions').countDocuments({ projectId: projectObjectId, deletedAt: null }),
    db.collection('budget_reallocations').countDocuments({ projectId: projectObjectId, deletedAt: null }),
    db.collection('budget_adjustments').countDocuments({ projectId: projectObjectId, deletedAt: null }),
    db.collection('budget_transfers').countDocuments({ projectId: projectObjectId, deletedAt: null }),
    db.collection('contingency_draws').countDocuments({ projectId: projectObjectId, deletedAt: null }),
    db.collection('approvals').countDocuments({ projectId: projectObjectId }),
    db.collection('project_memberships').countDocuments({ projectId: projectObjectId }),
    db.collection('project_teams').countDocuments({ projectId: projectObjectId }),
    db.collection('notifications').countDocuments({ projectId: projectObjectId }),
    db.collection('audit_logs').countDocuments({ projectId: projectObjectId }),
    db.collection('scheduled_reports').countDocuments({ projectId: projectObjectId, deletedAt: null }), // CRITICAL FIX: Added missing dependency
  ]);

  return {
    materials,
    expenses,
    initialExpenses,
    floors,
    phases,
    workItems,
    labourEntries,
    labourBatches,
    labourCostSummaries,
    materialRequests,
    materialRequestBatches,
    purchaseOrders,
    equipment,
    subcontractors,
    professionalServices,
    professionalFees,
    professionalActivities,
    siteReports,
    supervisorSubmissions,
    budgetReallocations,
    budgetAdjustments,
    budgetTransfers,
    contingencyDraws,
    approvals,
    projectMemberships,
    projectTeams,
    notifications,
    auditLogs,
    scheduledReports, // CRITICAL: Added missing dependency
  };
}
